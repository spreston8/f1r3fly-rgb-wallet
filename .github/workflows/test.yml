name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Unit Tests - No services required
  # ==========================================================================
  unit-tests:
    name: Unit Tests (Keys & Storage)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
      
      - name: Run keys tests
        run: |
          set -o pipefail
          cargo test --test keys_test -- --nocapture 2>&1 | tee test-keys-output.log || (cat test-keys-output.log && exit 1)
      
      - name: Run storage tests
        run: |
          set -o pipefail
          cargo test --test storage_test -- --nocapture 2>&1 | tee test-storage-output.log || (cat test-storage-output.log && exit 1)
      
      - name: Run byte order tests
        run: |
          set -o pipefail
          cargo test --test byte_order_test -- --nocapture 2>&1 | tee test-byte-order-output.log || (cat test-byte-order-output.log && exit 1)
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: target/debug/deps/*.log
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload failed test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-failed-logs
          path: |
            test-keys-output.log
            test-storage-output.log
            test-byte-order-output.log
            target/debug/deps/*.log
          retention-days: 7

  # ==========================================================================
  # Bitcoin Integration Tests
  # ==========================================================================
  bitcoin-integration:
    name: Bitcoin Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl protobuf-compiler
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-electrs-${{ hashFiles('ci/Dockerfile.electrs') }}
          restore-keys: |
            ${{ runner.os }}-buildx-electrs-
      
      - name: Build electrs with cache
        working-directory: ci
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.electrs \
            -t ci-electrs \
            --load \
            .
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Start Bitcoin services (bitcoind + electrs)
        run: |
          docker compose -f ci/docker-compose.yml up -d bitcoind electrs
      
      - name: Wait for Bitcoin services
        run: |
          timeout 180 bash -c 'until docker compose -f ci/docker-compose.yml ps bitcoind | grep -q "healthy"; do sleep 2; done'
          
          # Mine initial blocks
          docker compose -f ci/docker-compose.yml exec -T bitcoind \
            bitcoin-cli -regtest -rpcuser=user -rpcpassword=password \
            createwallet "mining_wallet" || true
          
          address=$(docker compose -f ci/docker-compose.yml exec -T bitcoind \
            bitcoin-cli -regtest -rpcuser=user -rpcpassword=password \
            -rpcwallet=mining_wallet getnewaddress)
          
          docker compose -f ci/docker-compose.yml exec -T bitcoind \
            bitcoin-cli -regtest -rpcuser=user -rpcpassword=password \
            -rpcwallet=mining_wallet generatetoaddress 103 "$address"
          
          # Wait for electrs to be healthy
          timeout 180 bash -c 'until docker compose -f ci/docker-compose.yml ps electrs | grep -q "healthy"; do sleep 2; done'
          
          echo "✅ Bitcoin services ready"
      
      - name: Run Bitcoin integration tests
        env:
          FIREFLY_PRIVATE_KEY: 5f668a7ee96d944a4494cc947e4005e172d7ab3461ee5538f1f2a45a835e9657
          BITCOIN_DATADIR: /tmp/bitcoin-ci
        run: |
          set -o pipefail
          cargo test --test bitcoin_integration_tests -- --test-threads=1 --nocapture 2>&1 | tee test-bitcoin-output.log || (cat test-bitcoin-output.log && exit 1)
      
      - name: Collect service logs
        if: always()
        run: ./ci/scripts/collect-logs.sh ci-logs-bitcoin
      
      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bitcoin-integration-logs
          path: ci-logs-bitcoin/
          retention-days: 7
      
      - name: Upload failed test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bitcoin-integration-failed-logs
          path: |
            test-bitcoin-output.log
            ci-logs-bitcoin/
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: docker compose -f ci/docker-compose.yml down -v

  # ==========================================================================
  # F1r3fly-RGB Integration Tests
  # ==========================================================================
  f1r3fly-integration:
    name: F1r3fly-RGB Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl protobuf-compiler
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-electrs-${{ hashFiles('ci/Dockerfile.electrs') }}
          restore-keys: |
            ${{ runner.os }}-buildx-electrs-
      
      - name: Build electrs with cache
        working-directory: ci
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.electrs \
            -t ci-electrs \
            --load \
            .
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Start all services (bitcoind + electrs + f1r3node)
        run: |
          docker compose -f ci/docker-compose.yml up -d
      
      - name: Wait for all services
        run: ./ci/scripts/wait-for-services.sh ci/docker-compose.yml
      
      - name: Run F1r3fly-RGB integration tests (sequential)
        env:
          FIREFLY_PRIVATE_KEY: 5f668a7ee96d944a4494cc947e4005e172d7ab3461ee5538f1f2a45a835e9657
          FIREFLY_HOST: localhost
          FIREFLY_GRPC_PORT: 40401
          FIREFLY_HTTP_PORT: 40403
          BITCOIN_DATADIR: /tmp/bitcoin-ci
        run: |
          set -o pipefail
          cargo test --test f1r3fly_integration_tests -- --test-threads=1 --nocapture 2>&1 | tee test-f1r3fly-output.log || (cat test-f1r3fly-output.log && exit 1)
      
      - name: Collect service logs
        if: always()
        run: ./ci/scripts/collect-logs.sh ci-logs-f1r3fly
      
      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: f1r3fly-integration-logs
          path: ci-logs-f1r3fly/
          retention-days: 7
      
      - name: Upload wallet test data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: f1r3fly-wallet-data
          path: |
            /tmp/f1r3fly-test-*
            ~/.f1r3fly-rgb-wallet
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload failed test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: f1r3fly-integration-failed-logs
          path: |
            test-f1r3fly-output.log
            ci-logs-f1r3fly/
            /tmp/f1r3fly-test-*
            ~/.f1r3fly-rgb-wallet
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: docker compose -f ci/docker-compose.yml down -v

  # ==========================================================================
  # List UTXOs Integration Tests
  # ==========================================================================
  list-utxos-integration:
    name: List UTXOs Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl protobuf-compiler
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-electrs-${{ hashFiles('ci/Dockerfile.electrs') }}
          restore-keys: |
            ${{ runner.os }}-buildx-electrs-
      
      - name: Build electrs with cache
        working-directory: ci
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.electrs \
            -t ci-electrs \
            --load \
            .
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Start all services (bitcoind + electrs + f1r3node)
        run: |
          docker compose -f ci/docker-compose.yml up -d
      
      - name: Wait for all services
        run: ./ci/scripts/wait-for-services.sh ci/docker-compose.yml
      
      - name: Run list_utxos integration tests
        env:
          FIREFLY_PRIVATE_KEY: 5f668a7ee96d944a4494cc947e4005e172d7ab3461ee5538f1f2a45a835e9657
          FIREFLY_HOST: localhost
          FIREFLY_GRPC_PORT: 40401
          FIREFLY_HTTP_PORT: 40403
          BITCOIN_DATADIR: /tmp/bitcoin-ci
        run: |
          set -o pipefail
          cargo test --test list_utxos_integration_test -- --test-threads=1 --nocapture test_bitcoin_layer_list_utxos test_rgb_layer_seal_info test_manager_orchestration_with_filters test_multiple_rgb_assets test_data_structures_and_edge_cases 2>&1 | tee test-list-utxos-output.log || (cat test-list-utxos-output.log && exit 1)
      
      - name: Collect service logs
        if: always()
        run: ./ci/scripts/collect-logs.sh ci-logs-list-utxos
      
      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: list-utxos-integration-logs
          path: ci-logs-list-utxos/
          retention-days: 7
      
      - name: Upload wallet test data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: list-utxos-wallet-data
          path: |
            /tmp/f1r3fly-test-*
            ~/.f1r3fly-rgb-wallet
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload failed test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: list-utxos-integration-failed-logs
          path: |
            test-list-utxos-output.log
            ci-logs-list-utxos/
            /tmp/f1r3fly-test-*
            ~/.f1r3fly-rgb-wallet
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: docker compose -f ci/docker-compose.yml down -v

  # ==========================================================================
  # CLI Tests
  # ==========================================================================
  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl protobuf-compiler
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-electrs-${{ hashFiles('ci/Dockerfile.electrs') }}
          restore-keys: |
            ${{ runner.os }}-buildx-electrs-
      
      - name: Build electrs with cache
        working-directory: ci
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.electrs \
            -t ci-electrs \
            --load \
            .
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Start all services (bitcoind + electrs + f1r3node)
        run: |
          docker compose -f ci/docker-compose.yml up -d
      
      - name: Wait for all services
        run: ./ci/scripts/wait-for-services.sh ci/docker-compose.yml
      
      - name: Run CLI tests
        env:
          CI: true
          FIREFLY_PRIVATE_KEY: 5f668a7ee96d944a4494cc947e4005e172d7ab3461ee5538f1f2a45a835e9657
          FIREFLY_GRPC_HOST: localhost
          FIREFLY_GRPC_PORT: 40401
          FIREFLY_HTTP_PORT: 40403
        run: |
          set -o pipefail
          chmod +x test_cli.sh
          ./test_cli.sh 2>&1 | tee test-cli-output.log || (cat test-cli-output.log && exit 1)
      
      - name: Run CLI integration tests
        env:
          CI: true
          FIREFLY_PRIVATE_KEY: 5f668a7ee96d944a4494cc947e4005e172d7ab3461ee5538f1f2a45a835e9657
          FIREFLY_HOST: localhost
          FIREFLY_GRPC_PORT: 40401
          FIREFLY_HTTP_PORT: 40403
          BITCOIN_DATADIR: /tmp/bitcoin-ci
        run: |
          set -o pipefail
          cargo test --test cli_integration_test -- --test-threads=1 --nocapture 2>&1 | tee test-cli-integration-output.log || (cat test-cli-integration-output.log && exit 1)
      
      - name: Upload CLI test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cli-test-logs
          path: logs/test_cli_*.log
          retention-days: 7
      
      - name: Collect service logs
        if: always()
        run: ./ci/scripts/collect-logs.sh ci-logs-cli
      
      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cli-test-logs-services
          path: ci-logs-cli/
          retention-days: 7
      
      - name: Upload failed test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cli-test-failed-logs
          path: |
            test-cli-output.log
            test-cli-integration-output.log
            logs/test_cli_*.log
            ci-logs-cli/
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: docker compose -f ci/docker-compose.yml down -v

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, bitcoin-integration, f1r3fly-integration, list-utxos-integration, cli-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.bitcoin-integration.result }}" != "success" ] || \
             [ "${{ needs.f1r3fly-integration.result }}" != "success" ] || \
             [ "${{ needs.list-utxos-integration.result }}" != "success" ] || \
             [ "${{ needs.cli-tests.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi

